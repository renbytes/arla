
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="ARLA is a framework for building complex, multi-agent simulations with a focus on emergent behavior and artificial intelligence.">
      
      
        <meta name="author" content="Bordumb / Renbytes">
      
      
        <link rel="canonical" href="https://renbytes.github.io/arla/developer/creating-systems/">
      
      
        <link rel="prev" href="../creating-actions/">
      
      
        <link rel="next" href="../event-bus/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Creating a New System - Affective Reinforcement Learning Agents (ARLA)</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#creating-new-systems" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Affective Reinforcement Learning Agents (ARLA)" class="md-header__button md-logo" aria-label="Affective Reinforcement Learning Agents (ARLA)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Affective Reinforcement Learning Agents (ARLA)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Creating a New System
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/renbytes/arla" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    arla
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorials/first-simulation/" class="md-tabs__link">
          
  
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../guides/installation/" class="md-tabs__link">
          
  
  
  User Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../architecture/" class="md-tabs__link">
          
  
  
  Developer Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contributing/setup/" class="md-tabs__link">
          
  
  
  Contributor's Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/agent-core/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../blog/" class="md-tabs__link">
        
  
  
    
  
  ARLA Development Blog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Affective Reinforcement Learning Agents (ARLA)" class="md-nav__button md-logo" aria-label="Affective Reinforcement Learning Agents (ARLA)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Affective Reinforcement Learning Agents (ARLA)
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/renbytes/arla" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    arla
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/first-simulation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Building Your First Simulation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            User Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation & Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/running-simulations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running Simulations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/understanding-output/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Understanding the Output
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Developer Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Developer Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../creating-actions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating a New Action
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Creating a New System
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Creating a New System
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#system-architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      System Architecture Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Architecture Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-role-of-systems" class="md-nav__link">
    <span class="md-ellipsis">
      The Role of Systems
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      System Lifecycle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-communication-system" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Communication System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example: Communication System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-define-supporting-components" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Define Supporting Components
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-implement-the-communication-system" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Implement the Communication System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-create-the-communication-action" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Create the Communication Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-register-and-test-the-system" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Register and Test the System
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-system-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced System Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced System Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-system-coordination" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-System Coordination
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling and Recovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event-bus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The Event Bus
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Contributor's Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Contributor's Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/style-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Coding Standards & Style
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running Tests
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/agent-core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    agent-core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/agent-engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    agent-engine
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ARLA Development Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#system-architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      System Architecture Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Architecture Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-role-of-systems" class="md-nav__link">
    <span class="md-ellipsis">
      The Role of Systems
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      System Lifecycle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-communication-system" class="md-nav__link">
    <span class="md-ellipsis">
      Example: Communication System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example: Communication System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-define-supporting-components" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Define Supporting Components
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-implement-the-communication-system" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Implement the Communication System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-create-the-communication-action" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Create the Communication Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-register-and-test-the-system" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Register and Test the System
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-system-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced System Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced System Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-system-coordination" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-System Coordination
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling and Recovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="creating-new-systems">Creating New Systems</h1>
<p>Systems are the engines of logic in ARLA's ECS architecture. While Actions define what agents can do, Systems define how those actions (and other simulation rules) affect the world. This guide demonstrates building a complete communication system that showcases advanced patterns and best practices.</p>
<div class="admonition info">
<p class="admonition-title">System Design Philosophy</p>
<p>Systems should contain <strong>logic, not data</strong>. They operate on entities with specific component combinations and communicate through events, not direct calls. This separation enables modularity, testability, and concurrent execution.</p>
</div>
<h2 id="system-architecture-overview">System Architecture Overview</h2>
<h3 id="the-role-of-systems">The Role of Systems</h3>
<p>Systems in ARLA follow a specific pattern designed for scalability and maintainability:</p>
<div class="grid cards">
<ul>
<li>
<p><strong>Single Responsibility</strong></p>
<hr />
<p>Each system handles one specific domain (movement, combat, communication, etc.)</p>
</li>
<li>
<p><strong>Event-Driven</strong></p>
<hr />
<p>Systems communicate through the event bus, never direct method calls</p>
</li>
<li>
<p><strong>Stateless</strong></p>
<hr />
<p>Systems contain minimal local state, reading from and writing to Components</p>
</li>
<li>
<p><strong>Concurrent</strong></p>
<hr />
<p>Systems can execute concurrently via async/await patterns</p>
</li>
</ul>
</div>
<h3 id="system-lifecycle">System Lifecycle</h3>
<pre class="mermaid"><code>graph TD
    A[System Registration] --&gt; B[Initialization]
    B --&gt; C[Event Subscription]
    C --&gt; D[Main Loop]
    D --&gt; E[Event Processing]
    E --&gt; D
    D --&gt; F[Shutdown]

    style D fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style E fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px</code></pre>
<hr />
<h2 id="example-communication-system">Example: Communication System</h2>
<p>Let's build a comprehensive communication system that handles agent-to-agent messaging, relationship updates, and social dynamics.</p>
<h3 id="step-1-define-supporting-components">Step 1: Define Supporting Components</h3>
<p>First, create the components that store communication-related data:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Social Components</label><label for="__tabbed_1_2">Position Component</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">components/social_components.py</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">agent_core.core.ecs.component</span><span class="w"> </span><span class="kn">import</span> <span class="n">Component</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">Message</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a single communication event.&quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">sender_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">message_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &quot;greeting&quot;, &quot;trade_offer&quot;, &quot;warning&quot;, etc.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">urgency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">requires_response</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">CommunicationComponent</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores agent&#39;s communication abilities and message queue.&quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_range</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">language_skill</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_range</span> <span class="o">=</span> <span class="n">max_range</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">language_skill</span> <span class="o">=</span> <span class="n">language_skill</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sent_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">communication_cooldown</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_incoming_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a message to the agent&#39;s inbox.&quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_unread_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all unread messages and mark as read.&quot;&quot;&quot;</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="k">return</span> <span class="n">messages</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="s2">&quot;max_range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_range</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>            <span class="s2">&quot;language_skill&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_skill</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>            <span class="s2">&quot;message_queue&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>                <span class="p">{</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>                    <span class="s2">&quot;sender_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender_id</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>                    <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_type</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>                    <span class="s2">&quot;urgency&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">urgency</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>                    <span class="s2">&quot;requires_response&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">requires_response</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                <span class="p">}</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="p">],</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>            <span class="s2">&quot;communication_cooldown&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">communication_cooldown</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="p">}</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="k">class</span><span class="w"> </span><span class="nc">SocialMemoryComponent</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores agent&#39;s memories of other agents.&quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reputation_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interaction_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outcome</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update relationship based on interaction.&quot;&quot;&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="k">if</span> <span class="n">other_agent_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">other_agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>                <span class="s2">&quot;trust&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>                <span class="s2">&quot;familiarity&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>                <span class="s2">&quot;last_interaction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>                <span class="s2">&quot;interaction_count&quot;</span><span class="p">:</span> <span class="mi">0</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="p">}</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="n">relationship</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">other_agent_id</span><span class="p">]</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;interaction_count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;familiarity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;familiarity&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>        <span class="c1"># Adjust trust based on interaction outcome</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="k">if</span> <span class="n">outcome</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>            <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;trust&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;trust&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="k">elif</span> <span class="n">outcome</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>            <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;trust&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;trust&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_relationship_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get overall relationship strength with another agent.&quot;&quot;&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>        <span class="k">if</span> <span class="n">other_agent_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>            <span class="k">return</span> <span class="mf">0.5</span>  <span class="c1"># Neutral</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="n">rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">other_agent_id</span><span class="p">]</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">rel</span><span class="p">[</span><span class="s2">&quot;trust&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;familiarity&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>            <span class="s2">&quot;relationships&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>            <span class="s2">&quot;reputation_scores&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reputation_scores</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>            <span class="s2">&quot;interaction_history&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction_history</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>        <span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">components/position_component.py</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">agent_core.core.ecs.component</span><span class="w"> </span><span class="kn">import</span> <span class="n">Component</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">PositionComponent</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores spatial location for range-based communication.&quot;&quot;&quot;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">movement_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="nd">@property</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">distance_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_position</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate Manhattan distance to another position.&quot;&quot;&quot;</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">other_position</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">other_position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">move_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update position and track history.&quot;&quot;&quot;</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">movement_history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">))</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">movement_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>  <span class="c1"># Keep last 20 positions</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">movement_history</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>            <span class="s2">&quot;movement_history&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">movement_history</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>        <span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="step-2-implement-the-communication-system">Step 2: Implement the Communication System</h3>
<p>Now create the system that processes communication events:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Communication System</label><label for="__tabbed_2_2">System Registration</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">systems/communication_system.py</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">agent_engine.simulation.system</span><span class="w"> </span><span class="kn">import</span> <span class="n">System</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..components.social_components</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">CommunicationComponent</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span><span class="p">,</span> <span class="n">Message</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..components.position_component</span><span class="w"> </span><span class="kn">import</span> <span class="n">PositionComponent</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">CommunicationSystem</span><span class="p">(</span><span class="n">System</span><span class="p">):</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles agent-to-agent communication and social dynamics.&quot;&quot;&quot;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation_state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cognitive_scaffold</span><span class="p">):</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simulation_state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cognitive_scaffold</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="c1"># Subscribe to communication-related events</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="p">:</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;execute_communicate_action&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_communicate</span><span class="p">)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;tick_started&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_message_queue</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;agent_moved&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_communication_ranges</span><span class="p">)</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle communication action execution.&quot;&quot;&quot;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>        <span class="n">entity_id</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="s2">&quot;entity_id&quot;</span><span class="p">]</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>        <span class="n">action_plan</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="s2">&quot;action_plan_component&quot;</span><span class="p">]</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">action_plan</span><span class="o">.</span><span class="n">params</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>        <span class="n">current_tick</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_tick&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>        <span class="c1"># Validate communication attempt</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_communication</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_failure</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="s2">&quot;Invalid communication parameters&quot;</span><span class="p">)</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>            <span class="k">return</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>        <span class="c1"># Process the communication</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>        <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_communication</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">)</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_success</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="s2">&quot;Communication sent successfully&quot;</span><span class="p">)</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_failure</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="s2">&quot;Communication failed&quot;</span><span class="p">)</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_communication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that communication is possible.&quot;&quot;&quot;</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="c1"># Check sender has communication component</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>        <span class="n">comm_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">comm_comp</span><span class="p">:</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>        <span class="c1"># Check cooldown</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>        <span class="k">if</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">communication_cooldown</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>        <span class="c1"># Check required parameters</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>        <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target_agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;message_type&quot;</span><span class="p">,</span> <span class="s2">&quot;message_content&quot;</span><span class="p">]</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">param</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">required_params</span><span class="p">):</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>        <span class="c1"># Check target exists</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>        <span class="n">target_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;target_agent_id&quot;</span><span class="p">]</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>        <span class="n">target_comm_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_comm_comp</span><span class="p">:</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>        <span class="c1"># Check range if positions exist</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>        <span class="n">sender_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">PositionComponent</span><span class="p">)</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>        <span class="n">target_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="n">PositionComponent</span><span class="p">)</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>        <span class="k">if</span> <span class="n">sender_pos</span> <span class="ow">and</span> <span class="n">target_pos</span><span class="p">:</span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>            <span class="n">distance</span> <span class="o">=</span> <span class="n">sender_pos</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">target_pos</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>            <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">max_range</span><span class="p">:</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_communication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">current_tick</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process the actual communication between agents.&quot;&quot;&quot;</span>
<a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a>
<a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a>        <span class="n">target_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;target_agent_id&quot;</span><span class="p">]</span>
<a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a>        <span class="n">message_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">]</span>
<a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;message_content&quot;</span><span class="p">]</span>
<a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a>        <span class="n">urgency</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;urgency&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a>        <span class="n">requires_response</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requires_response&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a>
<a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a>        <span class="c1"># Get components</span>
<a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a>        <span class="n">sender_comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a>        <span class="n">target_comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a>        <span class="n">sender_social</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span><span class="p">)</span>
<a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a>        <span class="n">target_social</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span><span class="p">)</span>
<a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a>
<a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a>        <span class="c1"># Create message</span>
<a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
<a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a>            <span class="n">sender_id</span><span class="o">=</span><span class="n">sender_id</span><span class="p">,</span>
<a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a>            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
<a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a>            <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="p">,</span>
<a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">current_tick</span><span class="p">,</span>
<a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a>            <span class="n">urgency</span><span class="o">=</span><span class="n">urgency</span><span class="p">,</span>
<a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a>            <span class="n">requires_response</span><span class="o">=</span><span class="n">requires_response</span>
<a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a>        <span class="p">)</span>
<a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a>
<a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a>        <span class="c1"># Calculate communication success probability</span>
<a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a>        <span class="n">success_probability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_success_probability</span><span class="p">(</span>
<a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>            <span class="n">sender_id</span><span class="p">,</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">message_type</span>
<a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a>        <span class="p">)</span>
<a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>
<a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a>        <span class="n">success</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">success_probability</span>
<a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a>
<a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a>        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a>            <span class="c1"># Deliver message</span>
<a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>            <span class="n">target_comm</span><span class="o">.</span><span class="n">add_incoming_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a>            <span class="n">sender_comm</span><span class="o">.</span><span class="n">sent_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>
<a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a>            <span class="c1"># Update social memories</span>
<a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a>            <span class="k">if</span> <span class="n">sender_social</span><span class="p">:</span>
<a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a>                <span class="n">sender_social</span><span class="o">.</span><span class="n">update_relationship</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="s2">&quot;communication&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">)</span>
<a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a>
<a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a>            <span class="k">if</span> <span class="n">target_social</span><span class="p">:</span>
<a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a>                <span class="n">target_social</span><span class="o">.</span><span class="n">update_relationship</span><span class="p">(</span><span class="n">sender_id</span><span class="p">,</span> <span class="s2">&quot;communication&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">)</span>
<a id="__codelineno-2-118" name="__codelineno-2-118" href="#__codelineno-2-118"></a>
<a id="__codelineno-2-119" name="__codelineno-2-119" href="#__codelineno-2-119"></a>            <span class="c1"># Set cooldown</span>
<a id="__codelineno-2-120" name="__codelineno-2-120" href="#__codelineno-2-120"></a>            <span class="n">sender_comm</span><span class="o">.</span><span class="n">communication_cooldown</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 3 ticks</span>
<a id="__codelineno-2-121" name="__codelineno-2-121" href="#__codelineno-2-121"></a>
<a id="__codelineno-2-122" name="__codelineno-2-122" href="#__codelineno-2-122"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">sender_id</span><span class="si">}</span><span class="s2"> successfully sent </span><span class="si">{</span><span class="n">message_type</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-2-123" name="__codelineno-2-123" href="#__codelineno-2-123"></a>
<a id="__codelineno-2-124" name="__codelineno-2-124" href="#__codelineno-2-124"></a>            <span class="c1"># Publish communication event for other systems</span>
<a id="__codelineno-2-125" name="__codelineno-2-125" href="#__codelineno-2-125"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="p">:</span>
<a id="__codelineno-2-126" name="__codelineno-2-126" href="#__codelineno-2-126"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;communication_successful&quot;</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-2-127" name="__codelineno-2-127" href="#__codelineno-2-127"></a>                    <span class="s2">&quot;sender_id&quot;</span><span class="p">:</span> <span class="n">sender_id</span><span class="p">,</span>
<a id="__codelineno-2-128" name="__codelineno-2-128" href="#__codelineno-2-128"></a>                    <span class="s2">&quot;target_id&quot;</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
<a id="__codelineno-2-129" name="__codelineno-2-129" href="#__codelineno-2-129"></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
<a id="__codelineno-2-130" name="__codelineno-2-130" href="#__codelineno-2-130"></a>                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">current_tick</span>
<a id="__codelineno-2-131" name="__codelineno-2-131" href="#__codelineno-2-131"></a>                <span class="p">})</span>
<a id="__codelineno-2-132" name="__codelineno-2-132" href="#__codelineno-2-132"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-133" name="__codelineno-2-133" href="#__codelineno-2-133"></a>            <span class="c1"># Communication failed</span>
<a id="__codelineno-2-134" name="__codelineno-2-134" href="#__codelineno-2-134"></a>            <span class="k">if</span> <span class="n">sender_social</span><span class="p">:</span>
<a id="__codelineno-2-135" name="__codelineno-2-135" href="#__codelineno-2-135"></a>                <span class="n">sender_social</span><span class="o">.</span><span class="n">update_relationship</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span> <span class="s2">&quot;communication&quot;</span><span class="p">,</span> <span class="s2">&quot;negative&quot;</span><span class="p">)</span>
<a id="__codelineno-2-136" name="__codelineno-2-136" href="#__codelineno-2-136"></a>
<a id="__codelineno-2-137" name="__codelineno-2-137" href="#__codelineno-2-137"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">sender_id</span><span class="si">}</span><span class="s2">&#39;s </span><span class="si">{</span><span class="n">message_type</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2"> was ignored or misunderstood&quot;</span><span class="p">)</span>
<a id="__codelineno-2-138" name="__codelineno-2-138" href="#__codelineno-2-138"></a>
<a id="__codelineno-2-139" name="__codelineno-2-139" href="#__codelineno-2-139"></a>        <span class="k">return</span> <span class="n">success</span>
<a id="__codelineno-2-140" name="__codelineno-2-140" href="#__codelineno-2-140"></a>
<a id="__codelineno-2-141" name="__codelineno-2-141" href="#__codelineno-2-141"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_success_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-2-142" name="__codelineno-2-142" href="#__codelineno-2-142"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate probability of successful communication.&quot;&quot;&quot;</span>
<a id="__codelineno-2-143" name="__codelineno-2-143" href="#__codelineno-2-143"></a>
<a id="__codelineno-2-144" name="__codelineno-2-144" href="#__codelineno-2-144"></a>        <span class="n">base_probability</span> <span class="o">=</span> <span class="mf">0.7</span>
<a id="__codelineno-2-145" name="__codelineno-2-145" href="#__codelineno-2-145"></a>
<a id="__codelineno-2-146" name="__codelineno-2-146" href="#__codelineno-2-146"></a>        <span class="c1"># Factor in sender&#39;s language skill</span>
<a id="__codelineno-2-147" name="__codelineno-2-147" href="#__codelineno-2-147"></a>        <span class="n">sender_comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-2-148" name="__codelineno-2-148" href="#__codelineno-2-148"></a>        <span class="k">if</span> <span class="n">sender_comm</span><span class="p">:</span>
<a id="__codelineno-2-149" name="__codelineno-2-149" href="#__codelineno-2-149"></a>            <span class="n">base_probability</span> <span class="o">*=</span> <span class="n">sender_comm</span><span class="o">.</span><span class="n">language_skill</span>
<a id="__codelineno-2-150" name="__codelineno-2-150" href="#__codelineno-2-150"></a>
<a id="__codelineno-2-151" name="__codelineno-2-151" href="#__codelineno-2-151"></a>        <span class="c1"># Factor in relationship strength</span>
<a id="__codelineno-2-152" name="__codelineno-2-152" href="#__codelineno-2-152"></a>        <span class="n">sender_social</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span><span class="p">)</span>
<a id="__codelineno-2-153" name="__codelineno-2-153" href="#__codelineno-2-153"></a>        <span class="k">if</span> <span class="n">sender_social</span><span class="p">:</span>
<a id="__codelineno-2-154" name="__codelineno-2-154" href="#__codelineno-2-154"></a>            <span class="n">relationship_strength</span> <span class="o">=</span> <span class="n">sender_social</span><span class="o">.</span><span class="n">get_relationship_strength</span><span class="p">(</span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-2-155" name="__codelineno-2-155" href="#__codelineno-2-155"></a>            <span class="n">base_probability</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">relationship_strength</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-2-156" name="__codelineno-2-156" href="#__codelineno-2-156"></a>
<a id="__codelineno-2-157" name="__codelineno-2-157" href="#__codelineno-2-157"></a>        <span class="c1"># Message type modifiers</span>
<a id="__codelineno-2-158" name="__codelineno-2-158" href="#__codelineno-2-158"></a>        <span class="n">type_modifiers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-2-159" name="__codelineno-2-159" href="#__codelineno-2-159"></a>            <span class="s2">&quot;greeting&quot;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
<a id="__codelineno-2-160" name="__codelineno-2-160" href="#__codelineno-2-160"></a>            <span class="s2">&quot;compliment&quot;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>
<a id="__codelineno-2-161" name="__codelineno-2-161" href="#__codelineno-2-161"></a>            <span class="s2">&quot;trade_offer&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
<a id="__codelineno-2-162" name="__codelineno-2-162" href="#__codelineno-2-162"></a>            <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
<a id="__codelineno-2-163" name="__codelineno-2-163" href="#__codelineno-2-163"></a>            <span class="s2">&quot;insult&quot;</span><span class="p">:</span> <span class="mf">0.3</span>
<a id="__codelineno-2-164" name="__codelineno-2-164" href="#__codelineno-2-164"></a>        <span class="p">}</span>
<a id="__codelineno-2-165" name="__codelineno-2-165" href="#__codelineno-2-165"></a>
<a id="__codelineno-2-166" name="__codelineno-2-166" href="#__codelineno-2-166"></a>        <span class="n">modifier</span> <span class="o">=</span> <span class="n">type_modifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">message_type</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-2-167" name="__codelineno-2-167" href="#__codelineno-2-167"></a>        <span class="n">base_probability</span> <span class="o">*=</span> <span class="n">modifier</span>
<a id="__codelineno-2-168" name="__codelineno-2-168" href="#__codelineno-2-168"></a>
<a id="__codelineno-2-169" name="__codelineno-2-169" href="#__codelineno-2-169"></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">base_probability</span><span class="p">))</span>
<a id="__codelineno-2-170" name="__codelineno-2-170" href="#__codelineno-2-170"></a>
<a id="__codelineno-2-171" name="__codelineno-2-171" href="#__codelineno-2-171"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_message_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-172" name="__codelineno-2-172" href="#__codelineno-2-172"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process incoming messages for all agents each tick.&quot;&quot;&quot;</span>
<a id="__codelineno-2-173" name="__codelineno-2-173" href="#__codelineno-2-173"></a>
<a id="__codelineno-2-174" name="__codelineno-2-174" href="#__codelineno-2-174"></a>        <span class="n">current_tick</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_tick&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-2-175" name="__codelineno-2-175" href="#__codelineno-2-175"></a>
<a id="__codelineno-2-176" name="__codelineno-2-176" href="#__codelineno-2-176"></a>        <span class="c1"># Get all agents with communication components</span>
<a id="__codelineno-2-177" name="__codelineno-2-177" href="#__codelineno-2-177"></a>        <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_entities_with_components</span><span class="p">([</span>
<a id="__codelineno-2-178" name="__codelineno-2-178" href="#__codelineno-2-178"></a>            <span class="n">CommunicationComponent</span>
<a id="__codelineno-2-179" name="__codelineno-2-179" href="#__codelineno-2-179"></a>        <span class="p">])</span>
<a id="__codelineno-2-180" name="__codelineno-2-180" href="#__codelineno-2-180"></a>
<a id="__codelineno-2-181" name="__codelineno-2-181" href="#__codelineno-2-181"></a>        <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-2-182" name="__codelineno-2-182" href="#__codelineno-2-182"></a>            <span class="n">comm_comp</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">CommunicationComponent</span><span class="p">]</span>
<a id="__codelineno-2-183" name="__codelineno-2-183" href="#__codelineno-2-183"></a>
<a id="__codelineno-2-184" name="__codelineno-2-184" href="#__codelineno-2-184"></a>            <span class="c1"># Reduce cooldown</span>
<a id="__codelineno-2-185" name="__codelineno-2-185" href="#__codelineno-2-185"></a>            <span class="k">if</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">communication_cooldown</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-186" name="__codelineno-2-186" href="#__codelineno-2-186"></a>                <span class="n">comm_comp</span><span class="o">.</span><span class="n">communication_cooldown</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-2-187" name="__codelineno-2-187" href="#__codelineno-2-187"></a>
<a id="__codelineno-2-188" name="__codelineno-2-188" href="#__codelineno-2-188"></a>            <span class="c1"># Process incoming messages</span>
<a id="__codelineno-2-189" name="__codelineno-2-189" href="#__codelineno-2-189"></a>            <span class="n">unread_messages</span> <span class="o">=</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">get_unread_messages</span><span class="p">()</span>
<a id="__codelineno-2-190" name="__codelineno-2-190" href="#__codelineno-2-190"></a>
<a id="__codelineno-2-191" name="__codelineno-2-191" href="#__codelineno-2-191"></a>            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">unread_messages</span><span class="p">:</span>
<a id="__codelineno-2-192" name="__codelineno-2-192" href="#__codelineno-2-192"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_incoming_message</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">)</span>
<a id="__codelineno-2-193" name="__codelineno-2-193" href="#__codelineno-2-193"></a>
<a id="__codelineno-2-194" name="__codelineno-2-194" href="#__codelineno-2-194"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_incoming_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-2-195" name="__codelineno-2-195" href="#__codelineno-2-195"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a message received by an agent.&quot;&quot;&quot;</span>
<a id="__codelineno-2-196" name="__codelineno-2-196" href="#__codelineno-2-196"></a>
<a id="__codelineno-2-197" name="__codelineno-2-197" href="#__codelineno-2-197"></a>        <span class="c1"># Update social memory about the sender</span>
<a id="__codelineno-2-198" name="__codelineno-2-198" href="#__codelineno-2-198"></a>        <span class="n">social_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span><span class="p">)</span>
<a id="__codelineno-2-199" name="__codelineno-2-199" href="#__codelineno-2-199"></a>        <span class="k">if</span> <span class="n">social_comp</span><span class="p">:</span>
<a id="__codelineno-2-200" name="__codelineno-2-200" href="#__codelineno-2-200"></a>            <span class="n">social_comp</span><span class="o">.</span><span class="n">update_relationship</span><span class="p">(</span>
<a id="__codelineno-2-201" name="__codelineno-2-201" href="#__codelineno-2-201"></a>                <span class="n">message</span><span class="o">.</span><span class="n">sender_id</span><span class="p">,</span> 
<a id="__codelineno-2-202" name="__codelineno-2-202" href="#__codelineno-2-202"></a>                <span class="sa">f</span><span class="s2">&quot;received_</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">message_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
<a id="__codelineno-2-203" name="__codelineno-2-203" href="#__codelineno-2-203"></a>                <span class="s2">&quot;positive&quot;</span>
<a id="__codelineno-2-204" name="__codelineno-2-204" href="#__codelineno-2-204"></a>            <span class="p">)</span>
<a id="__codelineno-2-205" name="__codelineno-2-205" href="#__codelineno-2-205"></a>
<a id="__codelineno-2-206" name="__codelineno-2-206" href="#__codelineno-2-206"></a>        <span class="c1"># Generate response if required and conditions are met</span>
<a id="__codelineno-2-207" name="__codelineno-2-207" href="#__codelineno-2-207"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">requires_response</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_respond</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<a id="__codelineno-2-208" name="__codelineno-2-208" href="#__codelineno-2-208"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_automatic_response</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">)</span>
<a id="__codelineno-2-209" name="__codelineno-2-209" href="#__codelineno-2-209"></a>
<a id="__codelineno-2-210" name="__codelineno-2-210" href="#__codelineno-2-210"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">recipient_id</span><span class="si">}</span><span class="s2"> received </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">message_type</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">sender_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-211" name="__codelineno-2-211" href="#__codelineno-2-211"></a>
<a id="__codelineno-2-212" name="__codelineno-2-212" href="#__codelineno-2-212"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_should_respond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-2-213" name="__codelineno-2-213" href="#__codelineno-2-213"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if agent should automatically respond to message.&quot;&quot;&quot;</span>
<a id="__codelineno-2-214" name="__codelineno-2-214" href="#__codelineno-2-214"></a>
<a id="__codelineno-2-215" name="__codelineno-2-215" href="#__codelineno-2-215"></a>        <span class="c1"># Check if agent is busy (has cooldown)</span>
<a id="__codelineno-2-216" name="__codelineno-2-216" href="#__codelineno-2-216"></a>        <span class="n">comm_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-2-217" name="__codelineno-2-217" href="#__codelineno-2-217"></a>        <span class="k">if</span> <span class="n">comm_comp</span> <span class="ow">and</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">communication_cooldown</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-218" name="__codelineno-2-218" href="#__codelineno-2-218"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-2-219" name="__codelineno-2-219" href="#__codelineno-2-219"></a>
<a id="__codelineno-2-220" name="__codelineno-2-220" href="#__codelineno-2-220"></a>        <span class="c1"># Check relationship with sender</span>
<a id="__codelineno-2-221" name="__codelineno-2-221" href="#__codelineno-2-221"></a>        <span class="n">social_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span><span class="p">)</span>
<a id="__codelineno-2-222" name="__codelineno-2-222" href="#__codelineno-2-222"></a>        <span class="k">if</span> <span class="n">social_comp</span><span class="p">:</span>
<a id="__codelineno-2-223" name="__codelineno-2-223" href="#__codelineno-2-223"></a>            <span class="n">relationship_strength</span> <span class="o">=</span> <span class="n">social_comp</span><span class="o">.</span><span class="n">get_relationship_strength</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">sender_id</span><span class="p">)</span>
<a id="__codelineno-2-224" name="__codelineno-2-224" href="#__codelineno-2-224"></a>            <span class="c1"># More likely to respond to agents they have good relationships with</span>
<a id="__codelineno-2-225" name="__codelineno-2-225" href="#__codelineno-2-225"></a>            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">relationship_strength</span>
<a id="__codelineno-2-226" name="__codelineno-2-226" href="#__codelineno-2-226"></a>
<a id="__codelineno-2-227" name="__codelineno-2-227" href="#__codelineno-2-227"></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.3</span>  <span class="c1"># Default 30% response rate</span>
<a id="__codelineno-2-228" name="__codelineno-2-228" href="#__codelineno-2-228"></a>
<a id="__codelineno-2-229" name="__codelineno-2-229" href="#__codelineno-2-229"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_automatic_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">responder_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">original_message</span><span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-2-230" name="__codelineno-2-230" href="#__codelineno-2-230"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate an automatic response to a message.&quot;&quot;&quot;</span>
<a id="__codelineno-2-231" name="__codelineno-2-231" href="#__codelineno-2-231"></a>
<a id="__codelineno-2-232" name="__codelineno-2-232" href="#__codelineno-2-232"></a>        <span class="n">response_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_response_content</span><span class="p">(</span><span class="n">original_message</span><span class="p">)</span>
<a id="__codelineno-2-233" name="__codelineno-2-233" href="#__codelineno-2-233"></a>        <span class="n">response_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_response_type</span><span class="p">(</span><span class="n">original_message</span><span class="p">)</span>
<a id="__codelineno-2-234" name="__codelineno-2-234" href="#__codelineno-2-234"></a>
<a id="__codelineno-2-235" name="__codelineno-2-235" href="#__codelineno-2-235"></a>        <span class="c1"># Create response message</span>
<a id="__codelineno-2-236" name="__codelineno-2-236" href="#__codelineno-2-236"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
<a id="__codelineno-2-237" name="__codelineno-2-237" href="#__codelineno-2-237"></a>            <span class="n">sender_id</span><span class="o">=</span><span class="n">responder_id</span><span class="p">,</span>
<a id="__codelineno-2-238" name="__codelineno-2-238" href="#__codelineno-2-238"></a>            <span class="n">content</span><span class="o">=</span><span class="n">response_content</span><span class="p">,</span>
<a id="__codelineno-2-239" name="__codelineno-2-239" href="#__codelineno-2-239"></a>            <span class="n">message_type</span><span class="o">=</span><span class="n">response_type</span><span class="p">,</span>
<a id="__codelineno-2-240" name="__codelineno-2-240" href="#__codelineno-2-240"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">current_tick</span><span class="p">,</span>
<a id="__codelineno-2-241" name="__codelineno-2-241" href="#__codelineno-2-241"></a>            <span class="n">urgency</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># Responses are usually less urgent</span>
<a id="__codelineno-2-242" name="__codelineno-2-242" href="#__codelineno-2-242"></a>            <span class="n">requires_response</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-2-243" name="__codelineno-2-243" href="#__codelineno-2-243"></a>        <span class="p">)</span>
<a id="__codelineno-2-244" name="__codelineno-2-244" href="#__codelineno-2-244"></a>
<a id="__codelineno-2-245" name="__codelineno-2-245" href="#__codelineno-2-245"></a>        <span class="c1"># Send response</span>
<a id="__codelineno-2-246" name="__codelineno-2-246" href="#__codelineno-2-246"></a>        <span class="n">sender_comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">original_message</span><span class="o">.</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-2-247" name="__codelineno-2-247" href="#__codelineno-2-247"></a>        <span class="k">if</span> <span class="n">sender_comm</span><span class="p">:</span>
<a id="__codelineno-2-248" name="__codelineno-2-248" href="#__codelineno-2-248"></a>            <span class="n">sender_comm</span><span class="o">.</span><span class="n">add_incoming_message</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-2-249" name="__codelineno-2-249" href="#__codelineno-2-249"></a>
<a id="__codelineno-2-250" name="__codelineno-2-250" href="#__codelineno-2-250"></a>            <span class="c1"># Update responder&#39;s sent messages</span>
<a id="__codelineno-2-251" name="__codelineno-2-251" href="#__codelineno-2-251"></a>            <span class="n">responder_comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">responder_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-2-252" name="__codelineno-2-252" href="#__codelineno-2-252"></a>            <span class="k">if</span> <span class="n">responder_comm</span><span class="p">:</span>
<a id="__codelineno-2-253" name="__codelineno-2-253" href="#__codelineno-2-253"></a>                <span class="n">responder_comm</span><span class="o">.</span><span class="n">sent_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-2-254" name="__codelineno-2-254" href="#__codelineno-2-254"></a>                <span class="n">responder_comm</span><span class="o">.</span><span class="n">communication_cooldown</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Shorter cooldown for responses</span>
<a id="__codelineno-2-255" name="__codelineno-2-255" href="#__codelineno-2-255"></a>
<a id="__codelineno-2-256" name="__codelineno-2-256" href="#__codelineno-2-256"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">responder_id</span><span class="si">}</span><span class="s2"> automatically responded to </span><span class="si">{</span><span class="n">original_message</span><span class="o">.</span><span class="n">sender_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-257" name="__codelineno-2-257" href="#__codelineno-2-257"></a>
<a id="__codelineno-2-258" name="__codelineno-2-258" href="#__codelineno-2-258"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_response_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-2-259" name="__codelineno-2-259" href="#__codelineno-2-259"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate appropriate response content based on message type.&quot;&quot;&quot;</span>
<a id="__codelineno-2-260" name="__codelineno-2-260" href="#__codelineno-2-260"></a>
<a id="__codelineno-2-261" name="__codelineno-2-261" href="#__codelineno-2-261"></a>        <span class="n">response_templates</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-2-262" name="__codelineno-2-262" href="#__codelineno-2-262"></a>            <span class="s2">&quot;greeting&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Hello!&quot;</span><span class="p">,</span> <span class="s2">&quot;Hi there!&quot;</span><span class="p">,</span> <span class="s2">&quot;Greetings!&quot;</span><span class="p">],</span>
<a id="__codelineno-2-263" name="__codelineno-2-263" href="#__codelineno-2-263"></a>            <span class="s2">&quot;trade_offer&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;I&#39;ll consider it&quot;</span><span class="p">,</span> <span class="s2">&quot;What are you offering?&quot;</span><span class="p">,</span> <span class="s2">&quot;Not interested&quot;</span><span class="p">],</span>
<a id="__codelineno-2-264" name="__codelineno-2-264" href="#__codelineno-2-264"></a>            <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Thank you for the warning&quot;</span><span class="p">,</span> <span class="s2">&quot;I&#39;ll be careful&quot;</span><span class="p">,</span> <span class="s2">&quot;Noted&quot;</span><span class="p">],</span>
<a id="__codelineno-2-265" name="__codelineno-2-265" href="#__codelineno-2-265"></a>            <span class="s2">&quot;compliment&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Thank you!&quot;</span><span class="p">,</span> <span class="s2">&quot;That&#39;s kind of you&quot;</span><span class="p">,</span> <span class="s2">&quot;I appreciate that&quot;</span><span class="p">],</span>
<a id="__codelineno-2-266" name="__codelineno-2-266" href="#__codelineno-2-266"></a>            <span class="s2">&quot;insult&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;That&#39;s uncalled for&quot;</span><span class="p">,</span> <span class="s2">&quot;I disagree&quot;</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]</span>
<a id="__codelineno-2-267" name="__codelineno-2-267" href="#__codelineno-2-267"></a>        <span class="p">}</span>
<a id="__codelineno-2-268" name="__codelineno-2-268" href="#__codelineno-2-268"></a>
<a id="__codelineno-2-269" name="__codelineno-2-269" href="#__codelineno-2-269"></a>        <span class="n">templates</span> <span class="o">=</span> <span class="n">response_templates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">original_message</span><span class="o">.</span><span class="n">message_type</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;I understand&quot;</span><span class="p">])</span>
<a id="__codelineno-2-270" name="__codelineno-2-270" href="#__codelineno-2-270"></a>        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span>
<a id="__codelineno-2-271" name="__codelineno-2-271" href="#__codelineno-2-271"></a>
<a id="__codelineno-2-272" name="__codelineno-2-272" href="#__codelineno-2-272"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_response_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-2-273" name="__codelineno-2-273" href="#__codelineno-2-273"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine appropriate response type based on original message.&quot;&quot;&quot;</span>
<a id="__codelineno-2-274" name="__codelineno-2-274" href="#__codelineno-2-274"></a>
<a id="__codelineno-2-275" name="__codelineno-2-275" href="#__codelineno-2-275"></a>        <span class="n">response_mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-2-276" name="__codelineno-2-276" href="#__codelineno-2-276"></a>            <span class="s2">&quot;greeting&quot;</span><span class="p">:</span> <span class="s2">&quot;greeting&quot;</span><span class="p">,</span>
<a id="__codelineno-2-277" name="__codelineno-2-277" href="#__codelineno-2-277"></a>            <span class="s2">&quot;trade_offer&quot;</span><span class="p">:</span> <span class="s2">&quot;trade_response&quot;</span><span class="p">,</span>
<a id="__codelineno-2-278" name="__codelineno-2-278" href="#__codelineno-2-278"></a>            <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="s2">&quot;acknowledgment&quot;</span><span class="p">,</span>
<a id="__codelineno-2-279" name="__codelineno-2-279" href="#__codelineno-2-279"></a>            <span class="s2">&quot;compliment&quot;</span><span class="p">:</span> <span class="s2">&quot;gratitude&quot;</span><span class="p">,</span>
<a id="__codelineno-2-280" name="__codelineno-2-280" href="#__codelineno-2-280"></a>            <span class="s2">&quot;insult&quot;</span><span class="p">:</span> <span class="s2">&quot;defensive&quot;</span>
<a id="__codelineno-2-281" name="__codelineno-2-281" href="#__codelineno-2-281"></a>        <span class="p">}</span>
<a id="__codelineno-2-282" name="__codelineno-2-282" href="#__codelineno-2-282"></a>
<a id="__codelineno-2-283" name="__codelineno-2-283" href="#__codelineno-2-283"></a>        <span class="k">return</span> <span class="n">response_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">original_message</span><span class="o">.</span><span class="n">message_type</span><span class="p">,</span> <span class="s2">&quot;general_response&quot;</span><span class="p">)</span>
<a id="__codelineno-2-284" name="__codelineno-2-284" href="#__codelineno-2-284"></a>
<a id="__codelineno-2-285" name="__codelineno-2-285" href="#__codelineno-2-285"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_communication_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-286" name="__codelineno-2-286" href="#__codelineno-2-286"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update communication possibilities when agents move.&quot;&quot;&quot;</span>
<a id="__codelineno-2-287" name="__codelineno-2-287" href="#__codelineno-2-287"></a>
<a id="__codelineno-2-288" name="__codelineno-2-288" href="#__codelineno-2-288"></a>        <span class="c1"># This could trigger recalculation of who can communicate with whom</span>
<a id="__codelineno-2-289" name="__codelineno-2-289" href="#__codelineno-2-289"></a>        <span class="c1"># For now, we handle this dynamically in validation</span>
<a id="__codelineno-2-290" name="__codelineno-2-290" href="#__codelineno-2-290"></a>        <span class="k">pass</span>
<a id="__codelineno-2-291" name="__codelineno-2-291" href="#__codelineno-2-291"></a>
<a id="__codelineno-2-292" name="__codelineno-2-292" href="#__codelineno-2-292"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_publish_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-293" name="__codelineno-2-293" href="#__codelineno-2-293"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Signal successful action completion.&quot;&quot;&quot;</span>
<a id="__codelineno-2-294" name="__codelineno-2-294" href="#__codelineno-2-294"></a>        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
<a id="__codelineno-2-295" name="__codelineno-2-295" href="#__codelineno-2-295"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-296" name="__codelineno-2-296" href="#__codelineno-2-296"></a>
<a id="__codelineno-2-297" name="__codelineno-2-297" href="#__codelineno-2-297"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="p">:</span>
<a id="__codelineno-2-298" name="__codelineno-2-298" href="#__codelineno-2-298"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;action_outcome_ready&quot;</span><span class="p">,</span> <span class="n">event_data</span><span class="p">)</span>
<a id="__codelineno-2-299" name="__codelineno-2-299" href="#__codelineno-2-299"></a>
<a id="__codelineno-2-300" name="__codelineno-2-300" href="#__codelineno-2-300"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_publish_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-301" name="__codelineno-2-301" href="#__codelineno-2-301"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Signal action failure with reason.&quot;&quot;&quot;</span>
<a id="__codelineno-2-302" name="__codelineno-2-302" href="#__codelineno-2-302"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Communication failed: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-303" name="__codelineno-2-303" href="#__codelineno-2-303"></a>
<a id="__codelineno-2-304" name="__codelineno-2-304" href="#__codelineno-2-304"></a>        <span class="c1"># Update action outcome to reflect failure</span>
<a id="__codelineno-2-305" name="__codelineno-2-305" href="#__codelineno-2-305"></a>        <span class="n">action_plan</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action_plan_component&quot;</span><span class="p">)</span>
<a id="__codelineno-2-306" name="__codelineno-2-306" href="#__codelineno-2-306"></a>        <span class="k">if</span> <span class="n">action_plan</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">action_plan</span><span class="p">,</span> <span class="s2">&quot;outcome&quot;</span><span class="p">):</span>
<a id="__codelineno-2-307" name="__codelineno-2-307" href="#__codelineno-2-307"></a>            <span class="n">action_plan</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-2-308" name="__codelineno-2-308" href="#__codelineno-2-308"></a>            <span class="n">action_plan</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">reason</span>
<a id="__codelineno-2-309" name="__codelineno-2-309" href="#__codelineno-2-309"></a>
<a id="__codelineno-2-310" name="__codelineno-2-310" href="#__codelineno-2-310"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="p">:</span>
<a id="__codelineno-2-311" name="__codelineno-2-311" href="#__codelineno-2-311"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;action_outcome_ready&quot;</span><span class="p">,</span> <span class="n">event_data</span><span class="p">)</span>
<a id="__codelineno-2-312" name="__codelineno-2-312" href="#__codelineno-2-312"></a>
<a id="__codelineno-2-313" name="__codelineno-2-313" href="#__codelineno-2-313"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-314" name="__codelineno-2-314" href="#__codelineno-2-314"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main system update - most logic is event-driven.&quot;&quot;&quot;</span>
<a id="__codelineno-2-315" name="__codelineno-2-315" href="#__codelineno-2-315"></a>
<a id="__codelineno-2-316" name="__codelineno-2-316" href="#__codelineno-2-316"></a>        <span class="c1"># Perform periodic maintenance tasks</span>
<a id="__codelineno-2-317" name="__codelineno-2-317" href="#__codelineno-2-317"></a>        <span class="k">if</span> <span class="n">current_tick</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Every 100 ticks</span>
<a id="__codelineno-2-318" name="__codelineno-2-318" href="#__codelineno-2-318"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_old_messages</span><span class="p">(</span><span class="n">current_tick</span><span class="p">)</span>
<a id="__codelineno-2-319" name="__codelineno-2-319" href="#__codelineno-2-319"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_reputation_decay</span><span class="p">(</span><span class="n">current_tick</span><span class="p">)</span>
<a id="__codelineno-2-320" name="__codelineno-2-320" href="#__codelineno-2-320"></a>
<a id="__codelineno-2-321" name="__codelineno-2-321" href="#__codelineno-2-321"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_old_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-322" name="__codelineno-2-322" href="#__codelineno-2-322"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove old messages to prevent memory bloat.&quot;&quot;&quot;</span>
<a id="__codelineno-2-323" name="__codelineno-2-323" href="#__codelineno-2-323"></a>
<a id="__codelineno-2-324" name="__codelineno-2-324" href="#__codelineno-2-324"></a>        <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_entities_with_components</span><span class="p">([</span>
<a id="__codelineno-2-325" name="__codelineno-2-325" href="#__codelineno-2-325"></a>            <span class="n">CommunicationComponent</span>
<a id="__codelineno-2-326" name="__codelineno-2-326" href="#__codelineno-2-326"></a>        <span class="p">])</span>
<a id="__codelineno-2-327" name="__codelineno-2-327" href="#__codelineno-2-327"></a>
<a id="__codelineno-2-328" name="__codelineno-2-328" href="#__codelineno-2-328"></a>        <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-2-329" name="__codelineno-2-329" href="#__codelineno-2-329"></a>            <span class="n">comm_comp</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">CommunicationComponent</span><span class="p">]</span>
<a id="__codelineno-2-330" name="__codelineno-2-330" href="#__codelineno-2-330"></a>
<a id="__codelineno-2-331" name="__codelineno-2-331" href="#__codelineno-2-331"></a>            <span class="c1"># Keep only last 50 sent messages</span>
<a id="__codelineno-2-332" name="__codelineno-2-332" href="#__codelineno-2-332"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comm_comp</span><span class="o">.</span><span class="n">sent_messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
<a id="__codelineno-2-333" name="__codelineno-2-333" href="#__codelineno-2-333"></a>                <span class="n">comm_comp</span><span class="o">.</span><span class="n">sent_messages</span> <span class="o">=</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">sent_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">:]</span>
<a id="__codelineno-2-334" name="__codelineno-2-334" href="#__codelineno-2-334"></a>
<a id="__codelineno-2-335" name="__codelineno-2-335" href="#__codelineno-2-335"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_update_reputation_decay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-336" name="__codelineno-2-336" href="#__codelineno-2-336"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Slowly decay relationship strengths over time without interaction.&quot;&quot;&quot;</span>
<a id="__codelineno-2-337" name="__codelineno-2-337" href="#__codelineno-2-337"></a>
<a id="__codelineno-2-338" name="__codelineno-2-338" href="#__codelineno-2-338"></a>        <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_entities_with_components</span><span class="p">([</span>
<a id="__codelineno-2-339" name="__codelineno-2-339" href="#__codelineno-2-339"></a>            <span class="n">SocialMemoryComponent</span>
<a id="__codelineno-2-340" name="__codelineno-2-340" href="#__codelineno-2-340"></a>        <span class="p">])</span>
<a id="__codelineno-2-341" name="__codelineno-2-341" href="#__codelineno-2-341"></a>
<a id="__codelineno-2-342" name="__codelineno-2-342" href="#__codelineno-2-342"></a>        <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-2-343" name="__codelineno-2-343" href="#__codelineno-2-343"></a>            <span class="n">social_comp</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">SocialMemoryComponent</span><span class="p">]</span>
<a id="__codelineno-2-344" name="__codelineno-2-344" href="#__codelineno-2-344"></a>
<a id="__codelineno-2-345" name="__codelineno-2-345" href="#__codelineno-2-345"></a>            <span class="k">for</span> <span class="n">other_id</span><span class="p">,</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="n">social_comp</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-2-346" name="__codelineno-2-346" href="#__codelineno-2-346"></a>                <span class="n">time_since_interaction</span> <span class="o">=</span> <span class="n">current_tick</span> <span class="o">-</span> <span class="n">relationship</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_interaction&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-2-347" name="__codelineno-2-347" href="#__codelineno-2-347"></a>
<a id="__codelineno-2-348" name="__codelineno-2-348" href="#__codelineno-2-348"></a>                <span class="c1"># Decay familiarity if no recent interaction (after 200 ticks)</span>
<a id="__codelineno-2-349" name="__codelineno-2-349" href="#__codelineno-2-349"></a>                <span class="k">if</span> <span class="n">time_since_interaction</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-2-350" name="__codelineno-2-350" href="#__codelineno-2-350"></a>                    <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;familiarity&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.99</span>  <span class="c1"># Slow decay</span>
<a id="__codelineno-2-351" name="__codelineno-2-351" href="#__codelineno-2-351"></a>                    <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;familiarity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;familiarity&quot;</span><span class="p">])</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">systems/__init__.py</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.communication_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommunicationSystem</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CommunicationSystem&quot;</span><span class="p">]</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="step-3-create-the-communication-action">Step 3: Create the Communication Action</h3>
<p>Create the action that agents can use to communicate:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Communication Action</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">actions/communicate_action.py</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">agent_core.agents.actions.action_interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActionInterface</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">agent_core.agents.actions.action_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">action_registry</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">agent_core.agents.actions.base_action</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActionOutcome</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">agent_core.core.ecs.abstractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationState</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..components.social_components</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommunicationComponent</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..components.position_component</span><span class="w"> </span><span class="kn">import</span> <span class="n">PositionComponent</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="nd">@action_registry</span><span class="o">.</span><span class="n">register</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">CommunicateAction</span><span class="p">(</span><span class="n">ActionInterface</span><span class="p">):</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enables agents to send messages to nearby agents.&quot;&quot;&quot;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="n">MESSAGE_COSTS</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="s2">&quot;greeting&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        <span class="s2">&quot;trade_offer&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="s2">&quot;insult&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>        <span class="s2">&quot;compliment&quot;</span><span class="p">:</span> <span class="mf">0.4</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="p">}</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    <span class="nd">@property</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">action_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="k">return</span> <span class="s2">&quot;communicate&quot;</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>    <span class="nd">@property</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="k">return</span> <span class="s2">&quot;Communicate&quot;</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_base_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation_state</span><span class="p">:</span> <span class="n">SimulationState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="k">return</span> <span class="mf">1.0</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_possible_params</span><span class="p">(</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="n">simulation_state</span><span class="p">:</span> <span class="n">SimulationState</span><span class="p">,</span> 
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>        <span class="n">current_tick</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate communication possibilities based on context.&quot;&quot;&quot;</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="c1"># Check if agent can communicate</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>        <span class="n">comm_comp</span> <span class="o">=</span> <span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">comm_comp</span> <span class="ow">or</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">communication_cooldown</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>            <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>        <span class="n">pos_comp</span> <span class="o">=</span> <span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">PositionComponent</span><span class="p">)</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>        <span class="n">social_comp</span> <span class="o">=</span> <span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span><span class="p">)</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pos_comp</span><span class="p">:</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>            <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>        <span class="n">possible_actions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>        <span class="c1"># Find nearby agents</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>        <span class="n">nearby_agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_nearby_agents</span><span class="p">(</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>            <span class="n">simulation_state</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">pos_comp</span><span class="p">,</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">max_range</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>        <span class="p">)</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>        <span class="k">for</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="n">nearby_agents</span><span class="p">:</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>            <span class="k">if</span> <span class="n">target_id</span> <span class="o">==</span> <span class="n">entity_id</span><span class="p">:</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>                <span class="k">continue</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>            <span class="c1"># Generate context-appropriate messages</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>            <span class="n">relationship_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relationship_context</span><span class="p">(</span><span class="n">social_comp</span><span class="p">,</span> <span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>            <span class="n">message_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_message_options</span><span class="p">(</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>                <span class="n">relationship_context</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">current_tick</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>            <span class="p">)</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>            <span class="k">for</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">urgency</span><span class="p">,</span> <span class="n">requires_response</span> <span class="ow">in</span> <span class="n">message_options</span><span class="p">:</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>                <span class="n">possible_actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>                    <span class="s2">&quot;target_agent_id&quot;</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>                    <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="n">msg_type</span><span class="p">,</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>                    <span class="s2">&quot;message_content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>                    <span class="s2">&quot;urgency&quot;</span><span class="p">:</span> <span class="n">urgency</span><span class="p">,</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>                    <span class="s2">&quot;requires_response&quot;</span><span class="p">:</span> <span class="n">requires_response</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>                <span class="p">})</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>        <span class="k">return</span> <span class="n">possible_actions</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_find_nearby_agents</span><span class="p">(</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>        <span class="n">simulation_state</span><span class="p">:</span> <span class="n">SimulationState</span><span class="p">,</span> 
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>        <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>        <span class="n">pos_comp</span><span class="p">:</span> <span class="n">PositionComponent</span><span class="p">,</span> 
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>        <span class="n">max_range</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find agents within communication range.&quot;&quot;&quot;</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>        <span class="n">nearby</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>        <span class="n">my_pos</span> <span class="o">=</span> <span class="n">pos_comp</span><span class="o">.</span><span class="n">position</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>        <span class="c1"># Query all entities with position and communication components</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>        <span class="n">entities</span> <span class="o">=</span> <span class="n">simulation_state</span><span class="o">.</span><span class="n">get_entities_with_components</span><span class="p">([</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>            <span class="n">PositionComponent</span><span class="p">,</span> <span class="n">CommunicationComponent</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>        <span class="p">])</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>        <span class="k">for</span> <span class="n">other_id</span><span class="p">,</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>            <span class="k">if</span> <span class="n">other_id</span> <span class="o">==</span> <span class="n">entity_id</span><span class="p">:</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>                <span class="k">continue</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>            <span class="n">other_pos_comp</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">PositionComponent</span><span class="p">]</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>            <span class="n">distance</span> <span class="o">=</span> <span class="n">pos_comp</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">other_pos_comp</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>            <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">max_range</span><span class="p">:</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>                <span class="n">nearby</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">other_id</span><span class="p">,</span> <span class="n">distance</span><span class="p">))</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>        <span class="k">return</span> <span class="n">nearby</span>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_relationship_context</span><span class="p">(</span>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>        <span class="n">social_comp</span><span class="p">:</span> <span class="n">SocialMemoryComponent</span><span class="p">,</span> 
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>        <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get relationship context with target agent.&quot;&quot;&quot;</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">social_comp</span> <span class="ow">or</span> <span class="n">target_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">social_comp</span><span class="o">.</span><span class="n">relationships</span><span class="p">:</span>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>                <span class="s2">&quot;trust&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>                <span class="s2">&quot;familiarity&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>                <span class="s2">&quot;interaction_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>                <span class="s2">&quot;relationship_strength&quot;</span><span class="p">:</span> <span class="mf">0.5</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>            <span class="p">}</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>        <span class="n">relationship</span> <span class="o">=</span> <span class="n">social_comp</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">target_id</span><span class="p">]</span>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>        <span class="n">relationship_strength</span> <span class="o">=</span> <span class="n">social_comp</span><span class="o">.</span><span class="n">get_relationship_strength</span><span class="p">(</span><span class="n">target_id</span><span class="p">)</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>            <span class="s2">&quot;trust&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trust&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>            <span class="s2">&quot;familiarity&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;familiarity&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>            <span class="s2">&quot;interaction_count&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>            <span class="s2">&quot;relationship_strength&quot;</span><span class="p">:</span> <span class="n">relationship_strength</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>        <span class="p">}</span>
<a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>
<a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_message_options</span><span class="p">(</span>
<a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>        <span class="n">relationship_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
<a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>        <span class="n">distance</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
<a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>        <span class="n">current_tick</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
<a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate appropriate messages based on context.&quot;&quot;&quot;</span>
<a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>
<a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>        <span class="n">trust</span> <span class="o">=</span> <span class="n">relationship_context</span><span class="p">[</span><span class="s2">&quot;trust&quot;</span><span class="p">]</span>
<a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>        <span class="n">familiarity</span> <span class="o">=</span> <span class="n">relationship_context</span><span class="p">[</span><span class="s2">&quot;familiarity&quot;</span><span class="p">]</span>
<a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>
<a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>        <span class="c1"># Always available: basic greeting</span>
<a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;greeting&quot;</span><span class="p">,</span> <span class="s2">&quot;Hello there!&quot;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>
<a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>        <span class="c1"># Relationship-based messages</span>
<a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a>        <span class="k">if</span> <span class="n">trust</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
<a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;compliment&quot;</span><span class="p">,</span> <span class="s2">&quot;You&#39;re doing great work!&quot;</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;trade_offer&quot;</span><span class="p">,</span> <span class="s2">&quot;Want to trade resources?&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>
<a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a>        <span class="k">if</span> <span class="n">trust</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
<a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;Stay back!&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a>
<a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a>        <span class="c1"># Familiarity-based messages</span>
<a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a>        <span class="k">if</span> <span class="n">familiarity</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
<a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;casual_chat&quot;</span><span class="p">,</span> <span class="s2">&quot;How are things going?&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a>
<a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a>        <span class="c1"># Distance-based messages</span>
<a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a>        <span class="k">if</span> <span class="n">distance</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Adjacent</span>
<a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;whisper&quot;</span><span class="p">,</span> <span class="s2">&quot;Psst, over here...&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a>
<a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a>        <span class="k">return</span> <span class="n">options</span>
<a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a>
<a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a>        <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a>        <span class="n">simulation_state</span><span class="p">:</span> <span class="n">SimulationState</span><span class="p">,</span>
<a id="__codelineno-4-170" name="__codelineno-4-170" href="#__codelineno-4-170"></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-4-171" name="__codelineno-4-171" href="#__codelineno-4-171"></a>        <span class="n">current_tick</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-4-172" name="__codelineno-4-172" href="#__codelineno-4-172"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ActionOutcome</span><span class="p">:</span>
<a id="__codelineno-4-173" name="__codelineno-4-173" href="#__codelineno-4-173"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute communication action - logic handled by CommunicationSystem.&quot;&quot;&quot;</span>
<a id="__codelineno-4-174" name="__codelineno-4-174" href="#__codelineno-4-174"></a>
<a id="__codelineno-4-175" name="__codelineno-4-175" href="#__codelineno-4-175"></a>        <span class="n">target_id</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
<a id="__codelineno-4-176" name="__codelineno-4-176" href="#__codelineno-4-176"></a>        <span class="n">message_type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">,</span> <span class="s2">&quot;greeting&quot;</span><span class="p">)</span>
<a id="__codelineno-4-177" name="__codelineno-4-177" href="#__codelineno-4-177"></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-4-178" name="__codelineno-4-178" href="#__codelineno-4-178"></a>
<a id="__codelineno-4-179" name="__codelineno-4-179" href="#__codelineno-4-179"></a>        <span class="k">return</span> <span class="n">ActionOutcome</span><span class="p">(</span>
<a id="__codelineno-4-180" name="__codelineno-4-180" href="#__codelineno-4-180"></a>            <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Actual success determined by system</span>
<a id="__codelineno-4-181" name="__codelineno-4-181" href="#__codelineno-4-181"></a>            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2"> attempts to </span><span class="si">{</span><span class="n">message_type</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-4-182" name="__codelineno-4-182" href="#__codelineno-4-182"></a>            <span class="n">base_reward</span><span class="o">=</span><span class="mf">0.1</span>
<a id="__codelineno-4-183" name="__codelineno-4-183" href="#__codelineno-4-183"></a>        <span class="p">)</span>
<a id="__codelineno-4-184" name="__codelineno-4-184" href="#__codelineno-4-184"></a>
<a id="__codelineno-4-185" name="__codelineno-4-185" href="#__codelineno-4-185"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_vector</span><span class="p">(</span>
<a id="__codelineno-4-186" name="__codelineno-4-186" href="#__codelineno-4-186"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-4-187" name="__codelineno-4-187" href="#__codelineno-4-187"></a>        <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-4-188" name="__codelineno-4-188" href="#__codelineno-4-188"></a>        <span class="n">simulation_state</span><span class="p">:</span> <span class="n">SimulationState</span><span class="p">,</span>
<a id="__codelineno-4-189" name="__codelineno-4-189" href="#__codelineno-4-189"></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-4-190" name="__codelineno-4-190" href="#__codelineno-4-190"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-4-191" name="__codelineno-4-191" href="#__codelineno-4-191"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Encode action for machine learning.&quot;&quot;&quot;</span>
<a id="__codelineno-4-192" name="__codelineno-4-192" href="#__codelineno-4-192"></a>
<a id="__codelineno-4-193" name="__codelineno-4-193" href="#__codelineno-4-193"></a>        <span class="c1"># One-hot encode message types</span>
<a id="__codelineno-4-194" name="__codelineno-4-194" href="#__codelineno-4-194"></a>        <span class="n">message_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;greeting&quot;</span><span class="p">,</span> <span class="s2">&quot;trade_offer&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;insult&quot;</span><span class="p">,</span> <span class="s2">&quot;compliment&quot;</span><span class="p">,</span> <span class="s2">&quot;casual_chat&quot;</span><span class="p">]</span>
<a id="__codelineno-4-195" name="__codelineno-4-195" href="#__codelineno-4-195"></a>        <span class="n">message_type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">,</span> <span class="s2">&quot;greeting&quot;</span><span class="p">)</span>
<a id="__codelineno-4-196" name="__codelineno-4-196" href="#__codelineno-4-196"></a>
<a id="__codelineno-4-197" name="__codelineno-4-197" href="#__codelineno-4-197"></a>        <span class="n">type_encoding</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">message_type</span> <span class="k">else</span> <span class="mf">0.0</span> 
<a id="__codelineno-4-198" name="__codelineno-4-198" href="#__codelineno-4-198"></a>                        <span class="k">for</span> <span class="n">msg_type</span> <span class="ow">in</span> <span class="n">message_types</span><span class="p">]</span>
<a id="__codelineno-4-199" name="__codelineno-4-199" href="#__codelineno-4-199"></a>
<a id="__codelineno-4-200" name="__codelineno-4-200" href="#__codelineno-4-200"></a>        <span class="c1"># Additional features</span>
<a id="__codelineno-4-201" name="__codelineno-4-201" href="#__codelineno-4-201"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">type_encoding</span> <span class="o">+</span> <span class="p">[</span>
<a id="__codelineno-4-202" name="__codelineno-4-202" href="#__codelineno-4-202"></a>            <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;urgency&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>           <span class="c1"># Message urgency</span>
<a id="__codelineno-4-203" name="__codelineno-4-203" href="#__codelineno-4-203"></a>            <span class="mf">1.0</span> <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requires_response&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Expects response</span>
<a id="__codelineno-4-204" name="__codelineno-4-204" href="#__codelineno-4-204"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_relationship_strength_feature</span><span class="p">(</span><span class="n">simulation_state</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> 
<a id="__codelineno-4-205" name="__codelineno-4-205" href="#__codelineno-4-205"></a>                                                  <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
<a id="__codelineno-4-206" name="__codelineno-4-206" href="#__codelineno-4-206"></a>        <span class="p">]</span>
<a id="__codelineno-4-207" name="__codelineno-4-207" href="#__codelineno-4-207"></a>
<a id="__codelineno-4-208" name="__codelineno-4-208" href="#__codelineno-4-208"></a>        <span class="k">return</span> <span class="n">features</span>
<a id="__codelineno-4-209" name="__codelineno-4-209" href="#__codelineno-4-209"></a>
<a id="__codelineno-4-210" name="__codelineno-4-210" href="#__codelineno-4-210"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_relationship_strength_feature</span><span class="p">(</span>
<a id="__codelineno-4-211" name="__codelineno-4-211" href="#__codelineno-4-211"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-4-212" name="__codelineno-4-212" href="#__codelineno-4-212"></a>        <span class="n">simulation_state</span><span class="p">:</span> <span class="n">SimulationState</span><span class="p">,</span> 
<a id="__codelineno-4-213" name="__codelineno-4-213" href="#__codelineno-4-213"></a>        <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-4-214" name="__codelineno-4-214" href="#__codelineno-4-214"></a>        <span class="n">target_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-4-215" name="__codelineno-4-215" href="#__codelineno-4-215"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-4-216" name="__codelineno-4-216" href="#__codelineno-4-216"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get normalized relationship strength for ML features.&quot;&quot;&quot;</span>
<a id="__codelineno-4-217" name="__codelineno-4-217" href="#__codelineno-4-217"></a>
<a id="__codelineno-4-218" name="__codelineno-4-218" href="#__codelineno-4-218"></a>        <span class="n">social_comp</span> <span class="o">=</span> <span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span><span class="p">)</span>
<a id="__codelineno-4-219" name="__codelineno-4-219" href="#__codelineno-4-219"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">social_comp</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target_id</span><span class="p">:</span>
<a id="__codelineno-4-220" name="__codelineno-4-220" href="#__codelineno-4-220"></a>            <span class="k">return</span> <span class="mf">0.5</span>  <span class="c1"># Neutral</span>
<a id="__codelineno-4-221" name="__codelineno-4-221" href="#__codelineno-4-221"></a>
<a id="__codelineno-4-222" name="__codelineno-4-222" href="#__codelineno-4-222"></a>        <span class="k">return</span> <span class="n">social_comp</span><span class="o">.</span><span class="n">get_relationship_strength</span><span class="p">(</span><span class="n">target_id</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="step-4-register-and-test-the-system">Step 4: Register and Test the System</h3>
<p>Integrate the system into your simulation:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">System Registration</label><label for="__tabbed_4_2">Testing</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">run.py</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">agent_engine.simulation.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationManager</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.systems</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommunicationSystem</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.components.social_components</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommunicationComponent</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.components.position_component</span><span class="w"> </span><span class="kn">import</span> <span class="n">PositionComponent</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup_and_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">,</span> <span class="n">config_overrides</span><span class="p">):</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize and run simulation with communication system.&quot;&quot;&quot;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="c1"># Create simulation manager</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="n">manager</span> <span class="o">=</span> <span class="n">SimulationManager</span><span class="p">(</span><span class="n">config_overrides</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">)</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="c1"># Register the communication system</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="n">manager</span><span class="o">.</span><span class="n">register_system</span><span class="p">(</span><span class="n">CommunicationSystem</span><span class="p">)</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="c1"># Add agents with communication capabilities</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="k">await</span> <span class="n">_initialize_communicating_agents</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">config_overrides</span><span class="p">)</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="c1"># Run simulation</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_communicating_agents</span><span class="p">(</span><span class="n">manager</span><span class="p">:</span> <span class="n">SimulationManager</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create agents with communication and social components.&quot;&quot;&quot;</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>    <span class="n">agent_count</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_count&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">agent_count</span><span class="p">):</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        <span class="n">entity_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;agent_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="c1"># Add position component</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="n">pos_comp</span> <span class="o">=</span> <span class="n">PositionComponent</span><span class="p">(</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>            <span class="n">x</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">49</span><span class="p">),</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>            <span class="n">y</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">49</span><span class="p">)</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        <span class="p">)</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="n">manager</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">pos_comp</span><span class="p">)</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>        <span class="c1"># Add communication component</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="n">comm_comp</span> <span class="o">=</span> <span class="n">CommunicationComponent</span><span class="p">(</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>            <span class="n">max_range</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>            <span class="n">language_skill</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>        <span class="p">)</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>        <span class="n">manager</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">comm_comp</span><span class="p">)</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>        <span class="c1"># Add social memory component</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>        <span class="n">social_comp</span> <span class="o">=</span> <span class="n">SocialMemoryComponent</span><span class="p">()</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>        <span class="n">manager</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">social_comp</span><span class="p">)</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created communicating agent </span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2"> at position </span><span class="si">{</span><span class="n">pos_comp</span><span class="o">.</span><span class="n">position</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">test_communication_system.py</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">AsyncMock</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..systems.communication_system</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommunicationSystem</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..components.social_components</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommunicationComponent</span><span class="p">,</span> <span class="n">SocialMemoryComponent</span><span class="p">,</span> <span class="n">Message</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..components.position_component</span><span class="w"> </span><span class="kn">import</span> <span class="n">PositionComponent</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCommunicationSystem</span><span class="p">:</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">communication_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>        <span class="n">mock_state</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>        <span class="n">mock_config</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        <span class="n">mock_scaffold</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        <span class="n">system</span> <span class="o">=</span> <span class="n">CommunicationSystem</span><span class="p">(</span><span class="n">mock_state</span><span class="p">,</span> <span class="n">mock_config</span><span class="p">,</span> <span class="n">mock_scaffold</span><span class="p">)</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>        <span class="k">return</span> <span class="n">system</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_validate_communication_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">communication_system</span><span class="p">):</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test successful communication validation.&quot;&quot;&quot;</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>        <span class="c1"># Setup mock components</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>        <span class="n">sender_comm</span> <span class="o">=</span> <span class="n">CommunicationComponent</span><span class="p">(</span><span class="n">max_range</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">language_skill</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>        <span class="n">target_comm</span> <span class="o">=</span> <span class="n">CommunicationComponent</span><span class="p">()</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>        <span class="n">sender_pos</span> <span class="o">=</span> <span class="n">PositionComponent</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>        <span class="n">target_pos</span> <span class="o">=</span> <span class="n">PositionComponent</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Within range</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>        <span class="n">communication_system</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">comp_type</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>            <span class="p">(</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">):</span> <span class="n">sender_comm</span><span class="p">,</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>            <span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">):</span> <span class="n">target_comm</span><span class="p">,</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>            <span class="p">(</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="n">PositionComponent</span><span class="p">):</span> <span class="n">sender_pos</span><span class="p">,</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>            <span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">PositionComponent</span><span class="p">):</span> <span class="n">target_pos</span><span class="p">,</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">comp_type</span><span class="p">))</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>            <span class="s2">&quot;target_agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>            <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;greeting&quot;</span><span class="p">,</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>            <span class="s2">&quot;message_content&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello!&quot;</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>        <span class="p">}</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>        <span class="c1"># Test validation</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">communication_system</span><span class="o">.</span><span class="n">_validate_communication</span><span class="p">(</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>        <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_validate_communication_out_of_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">communication_system</span><span class="p">):</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test communication validation fails when out of range.&quot;&quot;&quot;</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>        <span class="n">sender_comm</span> <span class="o">=</span> <span class="n">CommunicationComponent</span><span class="p">(</span><span class="n">max_range</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>        <span class="n">target_comm</span> <span class="o">=</span> <span class="n">CommunicationComponent</span><span class="p">()</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>        <span class="n">sender_pos</span> <span class="o">=</span> <span class="n">PositionComponent</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>        <span class="n">target_pos</span> <span class="o">=</span> <span class="n">PositionComponent</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Out of range</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>        <span class="n">communication_system</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">comp_type</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>            <span class="p">(</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">):</span> <span class="n">sender_comm</span><span class="p">,</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>            <span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">):</span> <span class="n">target_comm</span><span class="p">,</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>            <span class="p">(</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="n">PositionComponent</span><span class="p">):</span> <span class="n">sender_pos</span><span class="p">,</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>            <span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">PositionComponent</span><span class="p">):</span> <span class="n">target_pos</span><span class="p">,</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">comp_type</span><span class="p">))</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>            <span class="s2">&quot;target_agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>            <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;greeting&quot;</span><span class="p">,</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>            <span class="s2">&quot;message_content&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello!&quot;</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>        <span class="p">}</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">communication_system</span><span class="o">.</span><span class="n">_validate_communication</span><span class="p">(</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>        <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_process_incoming_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">communication_system</span><span class="p">):</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test processing of incoming messages.&quot;&quot;&quot;</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>        <span class="c1"># Setup components</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>        <span class="n">social_comp</span> <span class="o">=</span> <span class="n">SocialMemoryComponent</span><span class="p">()</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>        <span class="n">communication_system</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">social_comp</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>        <span class="c1"># Create test message</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>            <span class="n">sender_id</span><span class="o">=</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>            <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Hello!&quot;</span><span class="p">,</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>            <span class="n">message_type</span><span class="o">=</span><span class="s2">&quot;greeting&quot;</span><span class="p">,</span>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>            <span class="n">urgency</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>            <span class="n">requires_response</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a>        <span class="p">)</span>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>        <span class="c1"># Process message</span>
<a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>        <span class="k">await</span> <span class="n">communication_system</span><span class="o">.</span><span class="n">_process_incoming_message</span><span class="p">(</span><span class="s2">&quot;recipient&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>
<a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>        <span class="c1"># Verify relationship was updated</span>
<a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a>        <span class="k">assert</span> <span class="s2">&quot;sender&quot;</span> <span class="ow">in</span> <span class="n">social_comp</span><span class="o">.</span><span class="n">relationships</span>
<a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a>        <span class="k">assert</span> <span class="n">social_comp</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="s2">&quot;sender&quot;</span><span class="p">][</span><span class="s2">&quot;interaction_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<h2 id="advanced-system-patterns">Advanced System Patterns</h2>
<h3 id="multi-system-coordination">Multi-System Coordination</h3>
<p>Systems can coordinate through events without direct coupling:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EconomySystem</span><span class="p">(</span><span class="n">System</span><span class="p">):</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Example of system that reacts to communication events.&quot;&quot;&quot;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation_state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cognitive_scaffold</span><span class="p">):</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simulation_state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cognitive_scaffold</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="p">:</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;communication_successful&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_communication</span><span class="p">)</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_communication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;React to successful communications for economic modeling.&quot;&quot;&quot;</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="c1"># Trade offers create economic opportunities</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">message_type</span> <span class="o">==</span> <span class="s2">&quot;trade_offer&quot;</span><span class="p">:</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_create_trade_opportunity</span><span class="p">(</span><span class="n">event_data</span><span class="p">[</span><span class="s2">&quot;sender_id&quot;</span><span class="p">],</span> <span class="n">event_data</span><span class="p">[</span><span class="s2">&quot;target_id&quot;</span><span class="p">])</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>        <span class="c1"># Social interactions affect reputation and market access</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">message_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;compliment&quot;</span><span class="p">,</span> <span class="s2">&quot;greeting&quot;</span><span class="p">]:</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_update_market_reputation</span><span class="p">(</span><span class="n">event_data</span><span class="p">[</span><span class="s2">&quot;sender_id&quot;</span><span class="p">],</span> <span class="n">event_data</span><span class="p">[</span><span class="s2">&quot;target_id&quot;</span><span class="p">])</span>
</code></pre></div>
<h3 id="performance-optimization">Performance Optimization</h3>
<p>For large-scale simulations, optimize system performance:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">OptimizedCommunicationSystem</span><span class="p">(</span><span class="n">CommunicationSystem</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Performance-optimized version for large simulations.&quot;&quot;&quot;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation_state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cognitive_scaffold</span><span class="p">):</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simulation_state</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">cognitive_scaffold</span><span class="p">)</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        <span class="c1"># Cache spatial queries</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_cache</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_tick</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        <span class="c1"># Batch message processing</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_message_batch</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="o">=</span> <span class="mi">100</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_find_nearby_agents_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation_state</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">pos_comp</span><span class="p">,</span> <span class="n">max_range</span><span class="p">):</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Use spatial caching to optimize range queries.&quot;&quot;&quot;</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        <span class="n">current_tick</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">simulation_state</span><span class="p">,</span> <span class="s1">&#39;current_tick&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>        <span class="c1"># Rebuild cache if stale</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>        <span class="k">if</span> <span class="n">current_tick</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_tick</span><span class="p">:</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_spatial_cache</span><span class="p">(</span><span class="n">simulation_state</span><span class="p">)</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_tick</span> <span class="o">=</span> <span class="n">current_tick</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>        <span class="c1"># Use cached spatial index</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_message_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch process messages for better performance.&quot;&quot;&quot;</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>        <span class="c1"># Collect all messages into batch</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>        <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_entities_with_components</span><span class="p">([</span><span class="n">CommunicationComponent</span><span class="p">])</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>        <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>            <span class="n">comm_comp</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">CommunicationComponent</span><span class="p">]</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>            <span class="n">unread_messages</span> <span class="o">=</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">get_unread_messages</span><span class="p">()</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">unread_messages</span><span class="p">:</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_message_batch</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>        <span class="c1"># Process batch</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_batch</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span><span class="p">:</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_message_batch</span><span class="p">()</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_message_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process messages in batch for efficiency.&quot;&quot;&quot;</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>        <span class="c1"># Group by recipient for better cache locality</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>        <span class="n">by_recipient</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>        <span class="k">for</span> <span class="n">recipient_id</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_batch</span><span class="p">:</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a>            <span class="k">if</span> <span class="n">recipient_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">by_recipient</span><span class="p">:</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>                <span class="n">by_recipient</span><span class="p">[</span><span class="n">recipient_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>            <span class="n">by_recipient</span><span class="p">[</span><span class="n">recipient_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>        <span class="c1"># Process grouped messages</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>        <span class="k">for</span> <span class="n">recipient_id</span><span class="p">,</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">by_recipient</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_incoming_message</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_tick</span><span class="p">)</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_message_batch</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>
<h3 id="error-handling-and-recovery">Error Handling and Recovery</h3>
<p>Implement robust error handling:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">RobustCommunicationSystem</span><span class="p">(</span><span class="n">CommunicationSystem</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Communication system with comprehensive error handling.&quot;&quot;&quot;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle communication with comprehensive error recovery.&quot;&quot;&quot;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>            <span class="n">entity_id</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="s2">&quot;entity_id&quot;</span><span class="p">]</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>            <span class="n">action_plan</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="s2">&quot;action_plan_component&quot;</span><span class="p">]</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">action_plan</span><span class="o">.</span><span class="n">params</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>            <span class="c1"># Validate with detailed error reporting</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>            <span class="n">validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_communication_detailed</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_publish_failure</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>                <span class="k">return</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>            <span class="c1"># Process with timeout protection</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>            <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_process_communication_safe</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">event_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_tick&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>                <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span>  <span class="c1"># 5 second timeout</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>            <span class="p">)</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_publish_success</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_publish_failure</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="s2">&quot;Communication processing failed&quot;</span><span class="p">)</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_failure</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="s2">&quot;Communication timed out&quot;</span><span class="p">)</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Communication system timed out for agent </span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_failure</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;System error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Communication system exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>            <span class="c1"># Log error for debugging</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;logger&#39;</span><span class="p">):</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Communication system error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_communication_detailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Detailed validation with specific error messages.&quot;&quot;&quot;</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>        <span class="nd">@dataclass</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>        <span class="k">class</span><span class="w"> </span><span class="nc">ValidationResult</span><span class="p">:</span>
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>            <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>            <span class="n">error_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>
<a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>        <span class="c1"># Check sender exists</span>
<a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">entity_exists</span><span class="p">(</span><span class="n">sender_id</span><span class="p">):</span>
<a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>            <span class="k">return</span> <span class="n">ValidationResult</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Sender does not exist&quot;</span><span class="p">)</span>
<a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>
<a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>        <span class="c1"># Check sender has communication component</span>
<a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>        <span class="n">comm_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_state</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">CommunicationComponent</span><span class="p">)</span>
<a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">comm_comp</span><span class="p">:</span>
<a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>            <span class="k">return</span> <span class="n">ValidationResult</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Sender lacks communication capability&quot;</span><span class="p">)</span>
<a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>
<a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>        <span class="c1"># Check cooldown</span>
<a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>        <span class="k">if</span> <span class="n">comm_comp</span><span class="o">.</span><span class="n">communication_cooldown</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a>            <span class="k">return</span> <span class="n">ValidationResult</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Sender on cooldown for </span><span class="si">{</span><span class="n">comm_comp</span><span class="o">.</span><span class="n">communication_cooldown</span><span class="si">}</span><span class="s2"> ticks&quot;</span><span class="p">)</span>
<a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a>
<a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>        <span class="c1"># Additional validations...</span>
<a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a>
<a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>        <span class="k">return</span> <span class="n">ValidationResult</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>This comprehensive communication system demonstrates advanced patterns for building robust, scalable systems in ARLA while maintaining the core principles of modularity and event-driven design.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Bordumb / Renbytes
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/renbytes" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/arla/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.instant", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>